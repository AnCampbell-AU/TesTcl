<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="TesTcl - a library for unit testing BigIp iRules : when you don&#39;t have the balls to test your iRules directly in production" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>TesTcl - a library for unit testing BigIp iRules</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/landro/TesTcl">View on GitHub</a>

          <h1 id="project_title">TesTcl - a library for unit testing BigIp iRules</h1>
          <h2 id="project_tagline">when you don&#39;t have the balls to test your iRules directly in production</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/landro/TesTcl/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/landro/TesTcl/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p><strong>TesTcl</strong> is a <a href="http://en.wikipedia.org/wiki/Tcl">Tcl</a> library for unit testing
<a href="https://devcentral.f5.com/HotTopics/iRules/tabid/1082202/Default.aspx">iRules</a> which 
are used when configuring <a href="http://www.f5.com/products/big-ip/">F5 BigIP</a> devices.</p>

<h2>
<a name="getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting started</h2>

<p>If you're familiar with unit testing and <a href="http://en.wikipedia.org/wiki/Mock_object">mocking</a> in particular,
using TesTcl should't be to hard. Check out the examples below:</p>

<h3>
<a name="simple-example" class="anchor" href="#simple-example"><span class="octicon octicon-link"></span></a>Simple example</h3>

<p>Let's say you want to test the following simple iRule found in <em>simple_irule.tcl</em>:</p>

<div class="highlight highlight-tcl"><pre><span class="nv">rule</span> simple <span class="k">{</span>

  <span class="nv">when</span> HTTP_REQUEST <span class="k">{</span>
    <span class="k">if</span> <span class="k">{</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>uri<span class="k">]</span> <span class="nv">starts_with</span> <span class="s2">"/foo"</span> <span class="k">}</span> <span class="k">{</span>
      <span class="nv">pool</span> foo
    <span class="k">}</span> <span class="k">else</span> <span class="k">{</span>
      <span class="nv">pool</span> bar
    <span class="k">}</span>
  <span class="k">}</span>

  <span class="nv">when</span> HTTP_RESPONSE <span class="k">{</span>
    <span class="nv">HTTP</span><span class="o">::</span>header remove <span class="s2">"Vary"</span>
    <span class="nv">HTTP</span><span class="o">::</span>header insert Vary <span class="s2">"Accept-Encoding"</span>
  <span class="k">}</span>

<span class="k">}</span>
</pre></div>

<p>Now, create a file called <em>test_simple_irule.tcl</em> containing the following lines:</p>

<div class="highlight highlight-tcl"><pre><span class="nb">package</span> require <span class="o">-</span>exact testcl <span class="mf">1.0</span>.5
<span class="k">namespace</span> import <span class="o">::</span>testcl::<span class="o">*</span>

<span class="c"># Comment in to enable logging</span>
<span class="c">#log::lvSuppressLE info 0</span>

<span class="nv">it</span> <span class="s2">"should handle request using pool bar"</span> <span class="k">{</span>
  <span class="nv">event</span> HTTP_REQUEST
  <span class="nv">on</span> HTTP::uri return <span class="s2">"/bar"</span>
  <span class="nv">endstate</span> pool bar
  <span class="nv">run</span> simple_irule.tcl simple
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should handle request using pool foo"</span> <span class="k">{</span>
  <span class="nv">event</span> HTTP_REQUEST
  <span class="nv">on</span> HTTP::uri return <span class="s2">"/foo/admin"</span>
  <span class="nv">endstate</span> pool foo
  <span class="nv">run</span> simple_irule.tcl simple
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should replace existing Vary http response headers with Accept-Encoding value"</span> <span class="k">{</span>
  <span class="nv">event</span> HTTP_RESPONSE
  <span class="nv">verify</span> <span class="s2">"there should be only one Vary header"</span> <span class="mi">1</span> <span class="o">==</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header count vary<span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"there should be Accept-Encoding value in Vary header"</span> <span class="s2">"Accept-Encoding"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header Vary<span class="k">}</span>
  <span class="nv">HTTP</span><span class="o">::</span>header insert Vary <span class="s2">"dummy value"</span>
  <span class="nv">HTTP</span><span class="o">::</span>header insert Vary <span class="s2">"another dummy value"</span>
  <span class="nv">run</span> irules<span class="o">/</span>simple_irule.tcl simple
<span class="k">}</span>
</pre></div>

<h4>
<a name="installing-jtcl-including-jtcl-irule-extensions" class="anchor" href="#installing-jtcl-including-jtcl-irule-extensions"><span class="octicon octicon-link"></span></a>Installing JTcl including jtcl-irule extensions</h4>

<h5>
<a name="install-jtcl" class="anchor" href="#install-jtcl"><span class="octicon octicon-link"></span></a>Install JTcl</h5>

<p>Download <a href="http://jtcl.kenai.com/">JTcl</a>, unzip it and add it to your path.</p>

<h5>
<a name="add-jtcl-irule-to-your-jtcl-installation" class="anchor" href="#add-jtcl-irule-to-your-jtcl-installation"><span class="octicon octicon-link"></span></a>Add jtcl-irule to your JTcl installation</h5>

<p>Add the <a href="http://landro.github.com/jtcl-irule/">jtcl-irule</a> extension to JTcl. If you don't have the time to build it yourself, you can download the 
jar artifact from the <a href="https://github.com/landro/TesTcl/downloads">downloads</a> section or you can use the direct <a href="https://github.com/downloads/landro/TesTcl/jtcl-irule.jar">link</a>.
Next, copy the jar file into the directory where you installed JTcl.
Add jtcl-irule to the classpath in <em>jtcl</em> or <em>jtcl.bat</em>.
<strong>IMPORTANT!</strong> Make sure you place the <em>jtcl-irule.jar</em> on the classpath <strong>before</strong> the standard jtcl-.jar
On MacOs X and Linux, this can be achieved by putting the following line just above the last line in the jtcl shell script</p>

<pre><code>export CLASSPATH=$dir/jtcl-irule.jar:$CLASSPATH
</code></pre>

<h5>
<a name="verify-installation" class="anchor" href="#verify-installation"><span class="octicon octicon-link"></span></a>Verify installation</h5>

<p>Create a script file named <em>test_jtcl_irule.tcl</em> containing the following lines </p>

<div class="highlight highlight-tcl"><pre><span class="k">if</span> <span class="k">{</span><span class="s2">"aa"</span> <span class="nv">starts_with</span> <span class="s2">"a"</span><span class="k">}</span> <span class="k">{</span>
  <span class="nb">puts</span> <span class="s2">"The jtcl-irule extension has successfully been installed"</span>
<span class="k">}</span>
</pre></div>

<p>and execute it using </p>

<pre><code>jtcl test_jtcl_irule.tcl
</code></pre>

<p>You should get a success message.</p>

<h5>
<a name="add-the-testcl-library-to-your-library-path" class="anchor" href="#add-the-testcl-library-to-your-library-path"><span class="octicon octicon-link"></span></a>Add the testcl library to your library path</h5>

<p>Download latest <a href="https://github.com/landro/TesTcl/releases">TesTcl distribution</a> from github containing all the files (including examples) found in the project.
Unzip, and add unzipped directory to the <a href="http://jtcl.kenai.com/gettingstarted.html">TCLLIBPATH</a> environment variable:</p>

<pre><code>export TCLLIBPATH=whereever/TesTcl-1.0.5
</code></pre>

<p>In order to run this example, type in the following at the command-line:</p>

<pre><code>&gt;jtcl test_simple_irule.tcl
</code></pre>

<p>This should give you the following output:</p>

<pre><code>**************************************************************************
* it should handle request using pool bar
**************************************************************************
-&gt; Test ok

**************************************************************************
* it should handle request using pool foo
**************************************************************************
-&gt; Test ok

**************************************************************************
* it should replace existing Vary http response headers with Accept-Encoding value
**************************************************************************
verification of 'there should be only one Vary header' done.
verification of 'there should be Accept-Encoding value in Vary header' done.
-&gt; Test ok
</code></pre>

<h4>
<a name="explanations" class="anchor" href="#explanations"><span class="octicon octicon-link"></span></a>Explanations</h4>

<ul>
<li>Require the <strong>testcl</strong> package and import the commands and variables found in the <strong>testcl</strong> namespace to use it.</li>
<li>Enable or disable logging</li>
<li>Add the specification tests

<ul>
<li>Describe every <em>it</em> statement as precisely as possible. It serves as documentation.</li>
<li>Add an <em>event</em> . <strong>This is mandatory.</strong>
</li>
<li>Add one or several <em>on</em> statements to setup expectations/mocks. If you don't care about the return value, return "".</li>
<li>Add an <em>endstate</em>. This could be a <em>pool</em>, <em>HTTP::respond</em>, <em>HTTP::redirect</em> or any other function call (see <a href="https://devcentral.f5.com/tech-tips/articles/-the101-irules-101-routing#.UW0OwoLfeN4">link</a>).</li>
<li>Add a <em>verify</em>. The verifications will be run immediately after the iRule execution. Describe every verification as precisely as possible, add as many *verification*s as needed in your particular test scenario.</li>
<li>Add an HTTP::header initialization if you are testing modification of HTTP headers (stubs/mocks are provided for all commands in HTTP namespace).</li>
<li>Add a <em>run</em> statement in order to actually run the Tcl script file containing your iRule. <strong>This is mandatory.</strong>
</li>
</ul>
</li>
</ul><h5>
<a name="a-word-on-the-testcl-commands" class="anchor" href="#a-word-on-the-testcl-commands"><span class="octicon octicon-link"></span></a>A word on the TesTcl commands</h5>

<ul>
<li>
<em>it</em> statement takes two arguments, description and code block to execute as test case.</li>
<li>
<em>event</em> statement takes a single argument - event type. Supported values are <a href="https://devcentral.f5.com/wiki/irules.Events.ashx">all standard HTTP, TCP and IP events .</a>
</li>
<li>
<em>on</em> statement has the following syntax: <em>on</em> ... (return|error) result</li>
<li>
<em>endstate</em> statement accepts 2 to 5 arguments which are matched with command to stop processing iRule with success in test case evaluation.</li>
<li>
<em>verify</em> statement takes four arguments. Syntax: <em>verify</em> "DESCRIPTION" value <em>CONDITION</em> {verification code}

<ul>
<li>
<em>description</em> is displayed during verification execution</li>
<li>
<em>value</em> is expected result of verification code</li>
<li>
<em>condition</em> is operator used during comparison of <em>value</em> with code result (ex. ==, !=, eq).</li>
<li>
<em>verification_code</em> is code to evaluate after iRule execution</li>
</ul>
</li>
<li>
<em>run</em> statement takes two arguments, file name of iRule source and name of iRule to execute</li>
</ul><h5>
<a name="a-word-on-stubsmocks-you-choose-what-to-call-em" class="anchor" href="#a-word-on-stubsmocks-you-choose-what-to-call-em"><span class="octicon octicon-link"></span></a>A word on stubs/mocks (you choose what to call 'em)</h5>

<p>There is a ready to use <em>HTTP::header</em> mockup implementation, which simulates behavior of original F5 implementation (as described at <a href="https://devcentral.f5.com/wiki/irules.HTTP__header.ashx">link</a>). 
However <em>insert_modssl_fields</em> subcommand is not supported in current version.
In addition, most of the other commands in the HTTP namespace have been implemented. We've done our best, but might have missed some details. Look at the sourcecode if 
you wonder what is going on in the mocks.</p>

<h4>
<a name="avoiding-code-duplication-using-the-before-command" class="anchor" href="#avoiding-code-duplication-using-the-before-command"><span class="octicon octicon-link"></span></a>Avoiding code duplication using the before command</h4>

<p>In order to avoid code duplication, one can use the <em>before</em> command.
The argument passed to the <em>before</em> command will be executed <em>before</em> the following <em>it</em> specifications.</p>

<p>NB! Be carefull with using <em>on</em> commands in <em>before</em>. If there will be another definition of the same expectation in <em>it</em> statement, only first one will be in use (this one set in <em>before</em>).</p>

<p>Using the <em>before</em> command, <em>test_simple_irule.tcl</em> can be rewritten as:</p>

<div class="highlight highlight-tcl"><pre><span class="nb">package</span> require <span class="o">-</span>exact testcl <span class="mf">1.0</span>.5
<span class="k">namespace</span> import <span class="o">::</span>testcl::<span class="o">*</span>

<span class="c"># Comment in to enable logging</span>
<span class="c">#log::lvSuppressLE info 0</span>

<span class="nv">before</span> <span class="k">{</span>
  <span class="nv">event</span> HTTP_REQUEST
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should handle request using pool bar"</span> <span class="k">{</span>
  <span class="nv">on</span> HTTP::uri return <span class="s2">"/bar"</span>
  <span class="nv">endstate</span> pool bar
  <span class="nv">run</span> simple_irule.tcl simple
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should handle request using pool foo"</span> <span class="k">{</span>
  <span class="nv">on</span> HTTP::uri return <span class="s2">"/foo/admin"</span>
  <span class="nv">endstate</span> pool foo
  <span class="nv">run</span> simple_irule.tcl simple
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should replace existing Vary http response headers with Accept-Encoding value"</span> <span class="k">{</span>
  <span class="c"># NB! override event type set in before</span>
  <span class="nv">event</span> HTTP_RESPONSE

  <span class="nv">verify</span> <span class="s2">"there should be only one Vary header"</span> <span class="mi">1</span> <span class="o">==</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header count vary<span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"there should be Accept-Encoding value in Vary header"</span> <span class="s2">"Accept-Encoding"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header Vary<span class="k">}</span>
  <span class="nv">HTTP</span><span class="o">::</span>header insert Vary <span class="s2">"dummy value"</span>
  <span class="nv">HTTP</span><span class="o">::</span>header insert Vary <span class="s2">"another dummy value"</span>
  <span class="nv">run</span> irules<span class="o">/</span>simple_irule.tcl simple
<span class="k">}</span>
</pre></div>

<p>On a side note, it's worth mentioning that there is no <em>after</em> command, since we're always dealing with mocks.</p>

<h3>
<a name="advanced-example" class="anchor" href="#advanced-example"><span class="octicon octicon-link"></span></a>Advanced example</h3>

<p>Let's have a look at a more advanced iRule (advanced_irule.tcl):</p>

<div class="highlight highlight-tcl"><pre><span class="nv">rule</span> advanced <span class="k">{</span>

  <span class="nv">when</span> HTTP_REQUEST <span class="k">{</span>

    <span class="nv">HTTP</span><span class="o">::</span>header insert X-Forwarded-SSL true

    <span class="k">if</span> <span class="k">{</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>uri<span class="k">]</span> <span class="nv">eq</span> <span class="s2">"/admin"</span> <span class="k">}</span> <span class="k">{</span>
      <span class="k">if</span> <span class="k">{</span> <span class="k">([</span><span class="nv">HTTP</span><span class="o">::</span>username<span class="k">]</span> <span class="nv">eq</span> <span class="s2">"admin"</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="k">([</span><span class="nv">HTTP</span><span class="o">::</span>password<span class="k">]</span> <span class="nv">eq</span> <span class="s2">"password"</span><span class="k">)</span> <span class="k">}</span> <span class="k">{</span>
        <span class="k">set</span> newuri <span class="k">[</span><span class="nb">string</span> map <span class="k">{</span><span class="o">/</span><span class="nv">admin</span><span class="o">/</span> <span class="o">/</span><span class="k">}</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>uri<span class="k">]]</span>
        <span class="nv">HTTP</span><span class="o">::</span>uri <span class="nv">$newuri</span>
        <span class="nv">pool</span> pool_admin_application
      <span class="k">}</span> <span class="k">else</span> <span class="k">{</span>
        <span class="nv">HTTP</span><span class="o">::</span>respond <span class="mi">401</span> WWW-Authenticate <span class="s2">"Basic realm=\"Restricted Area\""</span>
      <span class="k">}</span>
    <span class="k">}</span> <span class="k">elseif</span> <span class="k">{</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>uri<span class="k">]</span> <span class="nv">eq</span> <span class="s2">"/blocked"</span> <span class="k">}</span> <span class="k">{</span>
      <span class="nv">HTTP</span><span class="o">::</span>respond <span class="mi">403</span>
    <span class="k">}</span> <span class="k">elseif</span> <span class="k">{</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>uri<span class="k">]</span> <span class="nv">starts_with</span> <span class="s2">"/app"</span><span class="k">}</span> <span class="k">{</span>
      <span class="k">if</span> <span class="k">{</span> <span class="k">[</span><span class="nv">active_members</span> pool_application<span class="k">]</span> <span class="o">==</span> <span class="nv">0</span> <span class="k">}</span> <span class="k">{</span>
        <span class="k">if</span> <span class="k">{</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>header User-Agent<span class="k">]</span> <span class="nv">eq</span> <span class="s2">"Apache HTTP Client"</span> <span class="k">}</span> <span class="k">{</span>
          <span class="nv">HTTP</span><span class="o">::</span>respond <span class="mi">503</span>
        <span class="k">}</span> <span class="k">else</span> <span class="k">{</span>
          <span class="nv">HTTP</span><span class="o">::</span>redirect <span class="s2">"http://fallback.com"</span>
        <span class="k">}</span>
      <span class="k">}</span> <span class="k">else</span> <span class="k">{</span>
        <span class="k">set</span> newuri <span class="k">[</span><span class="nb">string</span> map <span class="k">{</span><span class="o">/</span><span class="nv">app</span><span class="o">/</span> <span class="o">/</span><span class="k">}</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>uri<span class="k">]]</span>
        <span class="nv">HTTP</span><span class="o">::</span>uri <span class="nv">$newuri</span>
        <span class="nv">pool</span> pool_application
      <span class="k">}</span>
    <span class="k">}</span> <span class="k">else</span> <span class="k">{</span>
      <span class="nv">HTTP</span><span class="o">::</span>respond <span class="mi">404</span>
    <span class="k">}</span>

  <span class="k">}</span>

<span class="k">}</span>
</pre></div>

<p>The specs for this iRule would look like this:</p>

<div class="highlight highlight-tcl"><pre><span class="nb">package</span> require <span class="o">-</span>exact testcl <span class="mf">1.0</span>.5
<span class="k">namespace</span> import <span class="o">::</span>testcl::<span class="o">*</span>

<span class="c"># Comment out to suppress logging</span>
<span class="c">#log::lvSuppressLE info 0</span>

<span class="nv">before</span> <span class="k">{</span>
  <span class="nv">event</span> HTTP_REQUEST
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should handle admin request using pool admin when credentials are valid"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>uri <span class="s2">"/admin"</span>
  <span class="nv">on</span> HTTP::username return <span class="s2">"admin"</span>
  <span class="nv">on</span> HTTP::password return <span class="s2">"password"</span>
  <span class="nv">endstate</span> pool pool_admin_application
  <span class="nv">run</span> irules<span class="o">/</span>advanced_irule.tcl advanced
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should ask for credentials when admin request with incorrect credentials"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>uri <span class="s2">"/admin"</span>
  <span class="nv">HTTP</span><span class="o">::</span>header insert Authorization <span class="s2">"Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ=="</span>
  <span class="nv">verify</span> <span class="s2">"user Aladdin"</span> <span class="s2">"Aladdin"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>username<span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"password 'open sesame'"</span> <span class="s2">"open sesame"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>password<span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"WWW-Authenticate header is 'Basic realm=\"Restricted Area\"'"</span> <span class="s2">"Basic realm=\"Restricted Area\""</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header <span class="s2">"WWW-Authenticate"</span><span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"response status code is 401"</span> <span class="mi">401</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>status<span class="k">}</span>
  <span class="nv">run</span> irules<span class="o">/</span>advanced_irule.tcl advanced
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should ask for credentials when admin request without credentials"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>uri <span class="s2">"/admin"</span>
  <span class="nv">verify</span> <span class="s2">"WWW-Authenticate header is 'Basic realm=\"Restricted Area\"'"</span> <span class="s2">"Basic realm=\"Restricted Area\""</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header <span class="s2">"WWW-Authenticate"</span><span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"response status code is 401"</span> <span class="mi">401</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>status<span class="k">}</span>
  <span class="nv">run</span> irules<span class="o">/</span>advanced_irule.tcl advanced
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should block access to uri /blocked"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>uri <span class="s2">"/blocked"</span>
  <span class="nv">endstate</span> HTTP::respond <span class="mi">403</span>
  <span class="nv">run</span> irules<span class="o">/</span>advanced_irule.tcl advanced
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should give apache http client a correct error code when app pool is down"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>uri <span class="s2">"/app"</span>
  <span class="nv">on</span> active_members pool_application return <span class="mi">0</span>
  <span class="nv">HTTP</span><span class="o">::</span>header insert User-Agent <span class="s2">"Apache HTTP Client"</span>
  <span class="nv">endstate</span> HTTP::respond <span class="mi">503</span>
  <span class="nv">run</span> irules<span class="o">/</span>advanced_irule.tcl advanced
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should give other clients then apache http client redirect to fallback when app pool is down"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>uri <span class="s2">"/app"</span>
  <span class="nv">on</span> active_members pool_application return <span class="mi">0</span>
  <span class="nv">HTTP</span><span class="o">::</span>header insert User-Agent <span class="s2">"Firefox 13.0.1"</span>
  <span class="nv">verify</span> <span class="s2">"response status code is 302"</span> <span class="mi">302</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>status<span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"Location header is 'http://fallback.com'"</span> <span class="s2">"http://fallback.com"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header Location<span class="k">}</span>
  <span class="nv">run</span> irules<span class="o">/</span>advanced_irule.tcl advanced
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should give handle app request using app pool when app pool is up"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>uri <span class="s2">"/app/form?test=query"</span>
  <span class="nv">on</span> active_members pool_application return <span class="mi">2</span>
  <span class="nv">endstate</span> pool pool_application
  <span class="nv">verify</span> <span class="s2">"result uri is /form?test=query"</span> <span class="s2">"/form?test=query"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>uri<span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"result path is /form"</span> <span class="s2">"/form"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>path<span class="k">}</span>
  <span class="nv">verify</span> <span class="s2">"result query is test=query"</span> <span class="s2">"test=query"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>query<span class="k">}</span>
  <span class="nv">run</span> irules<span class="o">/</span>advanced_irule.tcl advanced
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should give 404 when request cannot be handled"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>uri <span class="s2">"/cannot_be_handled"</span>
  <span class="nv">endstate</span> HTTP::respond <span class="mi">404</span>
  <span class="nv">run</span> irules<span class="o">/</span>advanced_irule.tcl advanced
<span class="k">}</span>

<span class="nv">stats</span>
</pre></div>

<h3>
<a name="modification-of-http-headers-example" class="anchor" href="#modification-of-http-headers-example"><span class="octicon octicon-link"></span></a>Modification of HTTP headers example</h3>

<p>Let's have a look at a another iRule (headers_irule.tcl):</p>

<div class="highlight highlight-tcl"><pre><span class="nv">rule</span> headers <span class="k">{</span>

  <span class="c">#notify backend about SSL using X-Forwarded-SSL http header</span>
  <span class="c">#if there is client certificate put common name into X-Common-Name-SSL http header</span>
  <span class="c">#if not make sure X-Common-Name-SSL header is not set</span>
  <span class="nv">when</span> HTTP_REQUEST <span class="k">{</span>
    <span class="nv">HTTP</span><span class="o">::</span>header insert X-Forwarded-SSL true
    <span class="nv">HTTP</span><span class="o">::</span>header remove X-Common-Name-SSL

    <span class="k">if</span> <span class="k">{</span> <span class="k">[</span><span class="nv">SSL</span><span class="o">::</span>cert count<span class="k">]</span> <span class="o">&gt;</span> <span class="nv">0</span> <span class="k">}</span> <span class="k">{</span>
      <span class="k">set</span> ssl_cert <span class="k">[</span><span class="nv">SSL</span><span class="o">::</span>cert <span class="mi">0</span><span class="k">]</span>
      <span class="k">set</span> subject <span class="k">[</span><span class="nv">X509</span><span class="o">::</span>subject <span class="nv">$ssl_cert</span><span class="k">]</span>
      <span class="k">set</span> cn <span class="s2">""</span>
      <span class="k">foreach</span> <span class="k">{</span> <span class="nv">label</span> value <span class="k">}</span> <span class="k">[</span><span class="nb">split</span> <span class="nv">$subject</span> <span class="s2">",="</span><span class="k">]</span> <span class="k">{</span>
        <span class="k">set</span> label <span class="k">[</span><span class="nb">string</span> toupper <span class="k">[</span><span class="nb">string</span> trim <span class="nv">$label</span><span class="k">]]</span>
        <span class="k">set</span> value <span class="k">[</span><span class="nb">string</span> trim <span class="nv">$value</span><span class="k">]</span>

        <span class="k">if</span> <span class="k">{</span> <span class="nv">$label</span> <span class="o">==</span> <span class="s2">"CN"</span> <span class="k">}</span> <span class="k">{</span>
          <span class="k">set</span> cn <span class="s2">"$value"</span>
          <span class="k">break</span>
        <span class="k">}</span>
      <span class="k">}</span>

      <span class="nv">HTTP</span><span class="o">::</span>header insert X-Common-Name-SSL <span class="s2">"$cn"</span>
    <span class="k">}</span>
  <span class="k">}</span>

<span class="k">}</span>
</pre></div>

<p>The example specs for this iRule would look like this:</p>

<div class="highlight highlight-tcl"><pre><span class="nb">package</span> require <span class="o">-</span>exact testcl <span class="mf">1.0</span>.5
<span class="k">namespace</span> import <span class="o">::</span>testcl::<span class="o">*</span>

<span class="c"># Comment out to suppress logging</span>
<span class="c">#log::lvSuppressLE info 0</span>

<span class="nv">before</span> <span class="k">{</span>
  <span class="nv">event</span> HTTP_REQUEST
  <span class="nv">verify</span> <span class="s2">"There should be always set HTTP header X-Forwarded-SSL to true"</span> true <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header X-Forwarded-SSL<span class="k">}</span>
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should remove X-Common-Name-SSL header from request if there was no client SSL certificate"</span> <span class="k">{</span>
  <span class="nv">HTTP</span><span class="o">::</span>header insert X-Common-Name-SSL <span class="s2">"testCommonName"</span>
  <span class="nv">on</span> SSL::cert count return <span class="mi">0</span>
  <span class="nv">verify</span> <span class="s2">"There should be no X-Common-Name-SSL"</span> <span class="mi">0</span> <span class="o">==</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header exists X-Common-Name-SSL<span class="k">}</span>
  <span class="nv">run</span> irules<span class="o">/</span>headers_irule.tcl headers
<span class="k">}</span>

<span class="nv">it</span> <span class="s2">"should add X-Common-Name-SSL with Common Name from client SSL certificate if it was available"</span> <span class="k">{</span>
  <span class="nv">on</span> SSL::cert count return <span class="mi">1</span>
  <span class="nv">on</span> SSL::cert <span class="mi">0</span> return <span class="k">{}</span>
  <span class="nv">on</span> X509::subject <span class="k">[</span><span class="nv">SSL</span><span class="o">::</span>cert <span class="mi">0</span><span class="k">]</span> return <span class="s2">"CN=testCommonName,DN=abc.de.fg"</span>
  <span class="nv">verify</span> <span class="s2">"X-Common-Name-SSL HTTP header value is the same as CN"</span> <span class="s2">"testCommonName"</span> <span class="ow">eq</span> <span class="k">{</span><span class="nv">HTTP</span><span class="o">::</span>header X-Common-Name-SSL<span class="k">}</span>
  <span class="nv">run</span> irules<span class="o">/</span>headers_irule.tcl headers
<span class="k">}</span>
</pre></div>

<h2>
<a name="how-stable-is-this-code" class="anchor" href="#how-stable-is-this-code"><span class="octicon octicon-link"></span></a>How stable is this code?</h2>

<p>This work is quite stable, but you can expect minor breaking changes.</p>

<h2>
<a name="why-i-created-this-project" class="anchor" href="#why-i-created-this-project"><span class="octicon octicon-link"></span></a>Why I created this project</h2>

<p>Configuring BigIP devices is no trivial task, and typically falls in under a DevOps kind of role.
In order to make your system perform the best it can, you need:</p>

<ul>
<li>In-depth knowledge about the BigIP system (typically requiring at least a <a href="http://www.f5.com/services/global-training/course-descriptions/big-ip-ltm-essentials.html">$1,995 3-day course</a>)</li>
<li>In-depth knowledge about the web application being load balanced </li>
<li>The Tcl language and the iRule extensions</li>
<li>And finally: <em>A way to test your iRules</em>
</li>
</ul><p>Most shops test iRules <a href="http://en.wikipedia.org/wiki/Manual_testing">manually</a>, the procedure typically being a variation of the following:</p>

<ul>
<li>Create/edit iRule</li>
<li>Add log statements that show execution path</li>
<li>Push iRule to staging/QA environment</li>
<li>Bring backend servers up and down <strong>manually</strong> as required to test fallback scenarios</li>
<li>Generate HTTP-traffic using a browser and verify <strong>manually</strong> everything works as expected</li>
<li>Verify log entries <strong>manually</strong>
</li>
<li>Remove or disable log statements</li>
<li>Push iRule to production environment</li>
<li>Verify <strong>manually</strong> everything works as expected </li>
</ul><p>There are lots of issues with this <strong>manual</strong> approach:</p>

<ul>
<li>Using log statements for testing and debugging messes up your code, and you still have to look through the logs <strong>manually</strong>
</li>
<li>Potentially using different iRules in QA and production make automated deployment procedures harder</li>
<li>Bringing servers up and down to test fallback scenarios can be quite tedious</li>
<li>
<strong>Manual</strong> verification steps are prone to error</li>
<li>
<strong>Manual</strong> testing takes a lot of time</li>
<li>Development roundtrip-time is forever, since deployment to BigIP sometimes can take several minutes</li>
</ul><p>Clearly, <strong>manual</strong> testing is not the way forward!</p>

<h2>
<a name="test-matrix-and-compatibility" class="anchor" href="#test-matrix-and-compatibility"><span class="octicon octicon-link"></span></a>Test matrix and compatibility</h2>

<table>
<thead><tr>
<th></th>
<th>Mac Os X</th>
<th>Windows</th>
<th>Cygwin</th>
</tr></thead>
<tbody>
<tr>
<td>JTcl  2.4.0</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>JTcl  2.5.0</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>JTcl  2.6.0</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>Tclsh 8.6</td>
<td>yes*</td>
<td>yes*</td>
<td>?</td>
</tr>
</tbody>
</table><p>The * indicates support only for standard Tcl commands</p>

<p>If you use TesTcl on a different platform, please let us know</p>

<h2>
<a name="getting-help" class="anchor" href="#getting-help"><span class="octicon octicon-link"></span></a>Getting help</h2>

<p>Post questions to the group at <a href="https://groups.google.com/forum/?fromgroups#!forum/testcl-user">TesTcl user group</a><br>
File bugs over at <a href="https://github.com/landro/TesTcl">github</a></p>

<h2>
<a name="contributing-code" class="anchor" href="#contributing-code"><span class="octicon octicon-link"></span></a>Contributing code</h2>

<p>Contributions are very welcomed. There are just a few things to remember:</p>

<ul>
<li>Run tests against JTcl since the custom iRule extensions have only been implemented to that Tcl implementations

<ul>
<li>Run <em>examples.sh</em> and <em>tests.sh</em> or their Windows equivalents, and verify output</li>
</ul>
</li>
<li>Please follow existing coding style and indentation (2 spaces for tabs)</li>
<li>Add new example or test when appropriate</li>
<li>Add or update documentation when necessary and make sure it is correct (as in test it)</li>
</ul><h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>Just like JTcl, TesTcl is licensed under a BSD-style license. </p>

<h2>
<a name="please-please-please" class="anchor" href="#please-please-please"><span class="octicon octicon-link"></span></a>Please please please</h2>

<p>Drop me a line if you use this library and find it useful: stefan.landro <strong>you know what</strong> gmail.com</p>

<p>You can also check out <a href="http://no.linkedin.com/in/landro">my LinkedIn profile</a> or 
<a href="https://plus.google.com/114497086993236232709?rel=author">my Google+ profile</a>, or 
even <a href="https://twitter.com/landro">my twitter account - follow it for TesTcl releases</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">TesTcl - a library for unit testing BigIp iRules maintained by <a href="https://github.com/landro">landro</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-33046216-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
